package es.david.ptctest;

import java.util.Set;

import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import es.david.ptctest.util.Globals;
import es.david.ptctest.util.Message;
import es.david.ptctest.util.Registered;
import es.david.ptctest.util.UtilMessage;

@Path("/register")
public class RegisterResources {
	private Registered registered;
	@GET
	@Produces(MediaType.TEXT_PLAIN)
	public String sayPlainTextHello() {
		return "Solo queria decirte que te quiero con locura y que me haces la persona mas feliz del mundo!! <3";
	}
		
	@POST
	@Produces(MediaType.TEXT_PLAIN)
	public Boolean registrar(String body){
		System.out.println(body);
		registered = Registered.singleton(Globals.fichRegistered);
		Message message = UtilMessage.stringToMessage(body);
		if(message!=null){
			Set<String> keys = message.keySet();
			for(String s: keys){
				System.out.println(s+": "+message.value(s));
			}
			String mail = message.value(Globals.MSG_MAIL);
			String regId = message.value(Globals.MSG_REG_ID);
			String role = message.value(Globals.MSG_ROLE);
			try {
				registered.backupUsers();
			} catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			if(Globals.ACTION_REQUESTER.equals(role) || Globals.ACTION_CONTAINER.equals(role)){
				System.out.println("Es un role valido.");
				try {
					return registered.addRegId(mail, regId, role);
				} catch (Exception e1) {
					// TODO Auto-generated catch block
					e1.printStackTrace();
				}
			}
	    	System.out.println(registered.getNUsers());
	    	return false;
		}
		return false;
		
	}
}
